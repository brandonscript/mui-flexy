#!/bin/bash

max_cpus=$(sysctl -n hw.ncpu)
max_cpus=$((max_cpus > 4 ? max_cpus : 4))
max_cpus=$((max_cpus - 1))

# Exit immediately if any command fails
set -e

# Run Jest tests (all unit tests)
echo "Running Jest tests..."
yarn jest --silent --verbose=false --reporters=summary --passWithNoTests

# Run type checking
echo ""
echo "Running type checking..."
yarn run typecheck

# Run linting
echo ""
echo "Running linting..."
yarn run lint

# Build all packages
echo ""
echo "Building all packages..."
yarn --silent run build:all

# Run Playwright tests (all e2e tests)
echo ""
echo "Running Playwright tests..."
npx playwright test --quiet --workers $max_cpus

# Auto-add package dist folders to git index immediately after build
git add packages/core/dist/ || true
git add packages/v5/dist/ || true  
git add packages/v6/dist/ || true
git add packages/v7/dist/ || true
git add docs/static/ || true
git add demos/v5/dist/ || true
git add demos/v6/dist/ || true
git add demos/v7/dist/ || true

# Refresh git index to ensure all changes are properly detected
git update-index --refresh || true

echo "Checking for unstaged changes in non-build files..."

# Check for unstaged changes OUTSIDE of build directories (these need manual review)
# git status --porcelain format: XY filename where Y is workspace status (space = clean, M = modified)
if git status --porcelain | grep '^.[M]' | grep -v -E "(packages/.*/dist/|docs/static/|demos/.*/dist/)" | grep . > /dev/null; then
  echo "Changes detected in non-build files. Please review and commit the following files:" >&2
  git status --porcelain | grep '^.[M]' | grep -v -E "(packages/.*/dist/|docs/static/|demos/.*/dist/)" >&2
  git update-index --again
  exit 1
fi

git update-index --again
